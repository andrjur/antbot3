# CLAUDE.md ‚Äî –í–∞–∂–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ AntBot v4

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–¥–æ–º.

---

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –î–ó ‚Äî –¥–≤–æ–π–Ω–æ–π –∫–æ–Ω—Ç—É—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç—É—Ä:** –ê–¥–º–∏–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä—É—á–Ω—É—é (–ø–æ–∫–∞ –∏–¥—ë—Ç —Ç–∞–π–º–µ—Ä)
- **–í—Ç–æ—Ä–æ–π –∫–æ–Ω—Ç—É—Ä:** n8n/–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Å–ª–µ HW_TIMEOUT_SECONDS
- **–¢—Ä–µ—Ç–∏–π –∫–æ–Ω—Ç—É—Ä:** –ê–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3√óHW_TIMEOUT_SECONDS –µ—Å–ª–∏ –ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª

**–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–±–∏—Ä–∞–π –∞–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ!** –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è n8n/OpenRouter.

### 2. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `format_time_duration()` –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏:
```python
format_time_duration(34)    # ‚Üí "34 —Å–µ–∫"
format_time_duration(242)   # ‚Üí "4 –º–∏–Ω 2 —Å–µ–∫"
format_time_duration(7200)  # ‚Üí "2 —á"
```

**–ó–∞–ø—Ä–µ—â–µ–Ω–æ:** –ü–∏—Å–∞—Ç—å –º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –≤ –∫–æ–¥–µ. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `HW_TIMEOUT_SECONDS` –∏–∑ `.env`.

### 3. –°–æ–æ–±—â–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç—É vs –∞–¥–º–∏–Ω—É
- **–°—Ç—É–¥–µ–Ω—Ç—É:** –ö—Ä–∞—Ç–∫–æ, –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
  - "‚úÖ –í–∞—à–µ –î–ó –ø—Ä–∏–Ω—è—Ç–æ."
  - "‚ùå –í–∞—à–µ –î–ó –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ."
- **–ê–¥–º–∏–Ω—É:** –ü–æ–¥—Ä–æ–±–Ω–æ, —Å –ø—Ä–∏—á–∏–Ω–æ–π
  - "‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º (–ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤ —Ç–µ—á–µ–Ω–∏–µ 34 —Å–µ–∫)"
  - "‚ö†Ô∏è –î–ó –≤—ã—à–µ –æ–¥–æ–±—Ä–µ–Ω–æ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò (–ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ 1 –º–∏–Ω 42 —Å–µ–∫)"

---

## üìÅ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –î–ó

| –§—É–Ω–∫—Ü–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –í–∞–∂–Ω–æ |
|---------|------------|-------|
| `check_pending_homework_timeout()` | –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä—ã—Ö –î–ó | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫, –∞–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3√ó—Ç–∞–π–º–∞—É—Ç |
| `handle_homework_result()` | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ | –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä—É—á–Ω–æ–º –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –ò–õ–ò –∞–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–∏ |
| `run_hw_countdown()` | –¢–∞–π–º–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –î–ó | –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É "ü§ñ –î–æ AI-–ø—Ä–æ–≤–µ—Ä–∫–∏: X —Å–µ–∫" |
| `format_time_duration()` | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—É–Ω–¥ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ |

### –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```python
HW_TIMEOUT_SECONDS = int(os.getenv("HW_TIMEOUT_SECONDS", "120"))  # –¢–∞–π–º–∞—É—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ n8n
homework_sent_to_n8n = set()  # –ú–Ω–æ–∂–µ—Å—Ç–≤–æ ID –î–ó, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ n8n
hw_countdown_tasks = {}  # –ó–∞–¥–∞—á–∏ —Ç–∞–π–º–µ—Ä–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞
```

---

## üîß –ö–æ–Ω–≤–µ–Ω—Ü–∏–∏ –∫–æ–¥–∞

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
logger.info(f"üì§ –î–ó #{admin_msg_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ n8n (–≤–æ–∑—Ä–∞—Å—Ç: {age_seconds:.0f} —Å–µ–∫)")
logger.warning(f"‚ö†Ô∏è –î–ó #{admin_msg_id} –≤–∏—Å–∏—Ç —É–∂–µ {age_seconds:.0f} —Å–µ–∫. –ê–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ.")
```

**–§–æ—Ä–º–∞—Ç:** Emoji + –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–∫–æ–±–∫–∞—Ö

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
–í—Å–µ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–π –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
```python
try:
    await bot.send_message(...)
except Exception as e_notify:
    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: {e_notify}")
    # –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–ª—å—à–µ ‚Äî —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ª–æ–º–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
```

### 3. FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
```python
class ManageHomeworkFSM(StatesGroup):
    waiting_homework_content = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –î–ó –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞
```

**–í–∞–∂–Ω–æ:** –ù–∞ –æ–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `@dp.message(F.text)` –¥–æ–±–∞–≤–ª—è–π —Ñ–∏–ª—å—Ç—Ä—ã:
- `StateFilter(None)` ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —é–∑–µ—Ä –Ω–µ –≤ FSM
- `~F.text.startswith('/')` ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã

---

## üö® –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. Telegram API ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
–ü—Ä–∏ `edit_message_caption` **–Ω–µ–ª—å–∑—è** –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞. –ù—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤–µ—Å—å caption —Ü–µ–ª–∏–∫–æ–º.

**–†–µ—à–µ–Ω–∏–µ:** –í `run_hw_countdown()` —Å–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç—Ä–æ—á–Ω–æ:
```python
updated_lines = []
for line in base_text.splitlines():
    if line.startswith("ü§ñ –î–æ AI-–ø—Ä–æ–≤–µ—Ä–∫–∏:"):
        updated_lines.append(timer_line)  # –ó–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–∞–π–º–µ—Ä
    else:
        updated_lines.append(line)  # –û—Å—Ç–∞–ª—å–Ω–æ–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

### 2. n8n webhook ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π callback URL
n8n **–Ω–µ –¥–æ–ª–∂–µ–Ω** –∏–º–µ—Ç—å –∂—ë—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω–Ω—ã–π URL –¥–ª—è callback. –ë–æ—Ç —Å–∞–º –ø–µ—Ä–µ–¥–∞—ë—Ç `callback_webhook_url_result` –≤ payload.

**–í n8n —É–∑–ª–µ HTTP Request:**
```
URL: {{ $('Webhook-homework').item.json.body.callback_webhook_url_result }}
```

### 3. Docker —Å–µ—Ç—å ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ vs –≤–Ω–µ—à–Ω–∏–µ URL
- **–í–Ω—É—Ç—Ä–∏ Docker:** `http://bot:8080` (–¥–ª—è —Å–≤—è–∑–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
- **–°–Ω–∞—Ä—É–∂–∏ (Cloudflare):** `https://bot.indikov.ru` (–¥–ª—è Telegram –∏ n8n callback)

**–ü—Ä–∞–≤–∏–ª–æ:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –≤–Ω–µ—à–Ω–∏–π URL –¥–ª—è callback –æ—Ç n8n!

---

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

### pending_admin_homework
–í—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –î–ó, –æ–∂–∏–¥–∞—é—â–∏—Ö –ø—Ä–æ–≤–µ—Ä–∫–∏.
```sql
CREATE TABLE pending_admin_homework (
    admin_message_id INTEGER PRIMARY KEY,  -- ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ
    admin_chat_id INTEGER,
    student_user_id INTEGER,
    course_numeric_id INTEGER,
    lesson_num INTEGER,
    student_message_id INTEGER,
    homework_text TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–í–∞–∂–Ω–æ:** –ó–∞–ø–∏—Å—å —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ:
- –†—É—á–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º
- –û–¥–æ–±—Ä–µ–Ω–∏—è –ò–ò (—á–µ—Ä–µ–∑ n8n)
- –ê–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏—è –ø–æ —Ç–∞–π–º–∞—É—Ç—É (3√óHW_TIMEOUT)

### homework_gallery
–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –î–ó.
```sql
CREATE TABLE homework_gallery (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    course_id TEXT,
    lesson_num INTEGER,
    status TEXT,  -- 'pending', 'approved', 'rejected'
    feedback_text TEXT,
    admin_message_id INTEGER  -- –î–ª—è —Å–≤—è–∑–∏ —Å pending_admin_homework
)
```

---

## üõ† –û—Ç–ª–∞–¥–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤
```bash
# –ü–æ—Å–º–æ—Ç—Ä–∏ —Ç–µ–∫—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
docker compose logs bot | grep "HW_TIMEOUT"

# –°–º–æ—Ç—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –î–ó
docker compose logs bot | grep "check_pending_homework_timeout"

# –°–º–æ—Ç—Ä–∏ –∞–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏—è
docker compose logs bot | grep "–ê–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ"
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
1. –£—Å—Ç–∞–Ω–æ–≤–∏ —Ç–∞–π–º–∞—É—Ç: `/set_hw_timeout 20`
2. –û—Ç–ø—Ä–∞–≤—å –î–ó –∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç
3. –ß–µ—Ä–µ–∑ 20 —Å–µ–∫ —É–≤–∏–¥–∏—à—å: "‚è≥ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞—á–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É –î–ó"
4. –ß–µ—Ä–µ–∑ 60 —Å–µ–∫ (3√ó20) —É–≤–∏–¥–∏—à—å: "‚ö†Ô∏è –î–ó –æ–¥–æ–±—Ä–µ–Ω–æ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò"

### 3. –°–∏–º—É–ª—è—Ü–∏—è —Å–±–æ—è n8n
–û—Ç–∫–ª—é—á–∏ n8n (`docker compose stop n8n`) –∏ –æ—Ç–ø—Ä–∞–≤—å –î–ó.
–ß–µ—Ä–µ–∑ 3√ó—Ç–∞–π–º–∞—É—Ç –±–æ—Ç –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–æ–¥–æ–±—Ä–∏—Ç—å.

---

## üìö –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

- `GOALS2.md` ‚Äî –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- `README.md` ‚Äî –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- `QUICK_START.md` ‚Äî –ö–æ–º–∞–Ω–¥—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- `INTEGRATION.md` ‚Äî –î–µ—Ç–∞–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å n8n

---

## ‚ö†Ô∏è –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

1. [ ] –ü—Ä–æ–≤–µ—Ä—å `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–æ—Å–æ–±–µ–Ω–Ω–æ `HW_TIMEOUT_SECONDS`)
2. [ ] –£–±–µ–¥–∏—Å—å —á—Ç–æ `WEBHOOK_SECRET_PATH` —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤ –±–æ—Ç–µ –∏ n8n
3. [ ] –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ `N8N_CALLBACK_SECRET=500` –≤ `.env` –∏ –≤ n8n webhook
4. [ ] –ó–∞–ø—É—Å—Ç–∏ `docker compose restart bot`
5. [ ] –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: `docker compose logs bot | tail -50`

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 27.02.2026
**–í–µ—Ä—Å–∏—è –±–æ—Ç–∞:** AntBot v4 —Å –∞–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ–º –î–ó
