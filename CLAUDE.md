# CLAUDE.md ‚Äî –í–∞–∂–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ AntBot v4

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 28.02.2026

---

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –î–ó ‚Äî –¥–≤–æ–π–Ω–æ–π –∫–æ–Ω—Ç—É—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç—É—Ä:** –ê–¥–º–∏–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä—É—á–Ω—É—é (–ø–æ–∫–∞ –∏–¥—ë—Ç —Ç–∞–π–º–µ—Ä)
- **–í—Ç–æ—Ä–æ–π –∫–æ–Ω—Ç—É—Ä:** n8n/–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Å–ª–µ HW_TIMEOUT_SECONDS
- **–¢—Ä–µ—Ç–∏–π –∫–æ–Ω—Ç—É—Ä:** –ê–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3√óHW_TIMEOUT_SECONDS –µ—Å–ª–∏ –ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª

**–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–±–∏—Ä–∞–π –∞–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ!** –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è n8n/OpenRouter.

### 2. n8n webhook ‚Äî –û–î–ò–ù –æ—Ç–≤–µ—Ç, –Ω–µ –¥–≤–∞!
**–ö–†–ò–¢–ò–ß–ù–û:** n8n –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å **–¢–û–õ–¨–ö–û –§–ò–ù–ê–õ–¨–ù–´–ô —Ä–µ–∑—É–ª—å—Ç–∞—Ç**.

**–ù–ï –ü–†–ê–í–ò–õ–¨–ù–û:**
- HTTP Request1: `{'status': 'processing'}` ‚ùå
- HTTP Request2: `{'is_approved': True, ...}` ‚ùå

**–ü–†–ê–í–ò–õ–¨–ù–û:**
- HTTP Request: `{'is_approved': True/False, 'feedback_text': '...'}` ‚úÖ

**–ü–æ—á–µ–º—É:** –ë–æ—Ç —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–∞–π–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ `run_hw_countdown`. –ù–µ –Ω—É–∂–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ò–ò –Ω–∞—á–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É".

### 3. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `format_time_duration()` –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏:
```python
format_time_duration(34)    # ‚Üí "34 —Å–µ–∫"
format_time_duration(242)   # ‚Üí "4 –º–∏–Ω 2 —Å–µ–∫"
format_time_duration(7200)  # ‚Üí "2 —á"
```

**–ó–∞–ø—Ä–µ—â–µ–Ω–æ:** –ü–∏—Å–∞—Ç—å –º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –≤ –∫–æ–¥–µ. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `HW_TIMEOUT_SECONDS` –∏–∑ `.env`.

### 4. –°–æ–æ–±—â–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç—É vs –∞–¥–º–∏–Ω—É
- **–°—Ç—É–¥–µ–Ω—Ç—É:** –ö—Ä–∞—Ç–∫–æ, —Å —Ç–µ–∫—Å—Ç–æ–º –ò–ò (–¥–æ 240 —Å–∏–º–≤–æ–ª–æ–≤)
  - "‚úÖ –í–∞—à–µ –î–ó –ø—Ä–∏–Ω—è—Ç–æ.\n\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ..."
- **–ê–¥–º–∏–Ω—É:** –ü–æ–¥—Ä–æ–±–Ω–æ, –≤ reply –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –î–ó
  - "–°—Ç–∞—Ç—É—Å –î–ó (—Å–æ–æ–±—â–µ–Ω–∏–µ –≤—ã—à–µ): ‚úÖ –û–î–û–ë–†–ï–ù–û"

---

## üìÅ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –§—É–Ω–∫—Ü–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –í–∞–∂–Ω–æ |
|---------|------------|-------|
| `handle_n8n_hw_approval()` | –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –æ—Ç n8n | **–°–Ω–∞—á–∞–ª–∞** –ø—Ä–æ–≤–µ—Ä–∫–∞ `status=processing`, **–ø–æ—Ç–æ–º** –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö |
| `handle_homework_result()` | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –î–ó | –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –ò–ò —Å—Ç—É–¥–µ–Ω—Ç—É + –∞–¥–º–∏–Ω–∞–º |
| `run_hw_countdown()` | –¢–∞–π–º–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –î–ó | 34 —Å–µ–∫ ‚Üí 0 —Å–µ–∫ ‚Üí –ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç (10 —Å–µ–∫) |
| `check_pending_homework_timeout()` | –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n —á–µ—Ä–µ–∑ 34 —Å–µ–∫ | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫ |

---

## üîß –ö–æ–Ω–≤–µ–Ω—Ü–∏–∏ –∫–æ–¥–∞

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (8 –ª–æ–≥–æ–≤ –≤ handle_n8n_hw_approval)
```python
logger.info('=== –ó–∞—à–ª–∏ –≤ handle_n8n_hw_approval ===')
logger.info(f"–ü–æ–ª—É—á–µ–Ω callback –æ—Ç n8n: {data}")
logger.info(f"status={data.get('status')}, is_approved={data.get('is_approved')}")
logger.info("üîπ –°—Ç–∞—Ç—É—Å processing - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º")
logger.info("üîπ –°—Ç–∞—Ç—É—Å NOT processing - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º")
logger.info(f"üîπ –î–∞–Ω–Ω—ã–µ: user=..., approved=...")
logger.info(f"üîπ feedback_text (len=...): ...")
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
–í—Å–µ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–π –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
```python
try:
    await bot.edit_message_reply_markup(..., reply_markup=None)
except Exception:
    pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É "message not modified"
```

### 3. –¢–µ–∫—Å—Ç –ò–ò (–¥–æ 240 —Å–∏–º–≤–æ–ª–æ–≤)
```python
feedback_short = feedback_text[:240] + "..." if len(feedback_text) > 240 else feedback_text
```

---

## üö® –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ö–æ–¥ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ `git pull` + `docker compose restart` –∫–æ–¥ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
git fetch origin
git reset --hard origin/main
docker compose down
docker compose up -d --build
```

**–°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è:** `./deploy.sh`

### 2. –¢–∞–π–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "0 —Å–µ–∫ –Ω–∞–∑–∞–¥"
**–†–µ—à–µ–Ω–∏–µ:** –í `handle_homework()` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
```python
f"ü§ñ –î–æ AI-–ø—Ä–æ–≤–µ—Ä–∫–∏: {HW_TIMEOUT_SECONDS} —Å–µ–∫\n"
```

### 3. –û—à–∏–±–∫–∞ "message is not modified"
**–†–µ—à–µ–Ω–∏–µ:** –û–±–æ—Ä–∞—á–∏–≤–∞—Ç—å `edit_message_reply_markup` –≤ `try...except pass`.

---

## üìö –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

- `main.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –±–æ—Ç–∞
- `GOALS2.md` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π, –º—ã—Å–ª–∏, –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- `CLAUDE.md` ‚Äî **—ç—Ç–æ—Ç —Ñ–∞–π–ª** (–≤–∞–∂–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏)
- `deploy.sh` ‚Äî —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
- `N8N_SETUP.md` ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ n8n

---

**–ü—Ä–∞–≤–∏–ª–æ:** CLAUDE.md –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ 5-15 –∑–∞–ø—Ä–æ—Å–æ–≤. –í—Å–µ –º—ã—Å–ª–∏ ‚Äî –≤ GOALS2.md.
