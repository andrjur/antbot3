
# AntBot v4 - –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥ –ø—Ä–∏–Ω—è—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–∞–≥–æ–≤ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞.
**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ö –ü–†–û–ß–¢–ï–ù–ò–Æ** –ø–µ—Ä–µ–¥ –≤–Ω–µ—Å–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥ –∏–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.

---

## üèóÔ∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ –ü–æ—Ä—Ç—ã (Docker + Cloudflare)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –∏ n8n –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ. n8n –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç—ã 80 –∏ 443. –¢–µ–ª–µ–≥—Ä–∞–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–±—Ö—É–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤ (443, 80, 8443, 88). –ë–æ—Ç –Ω–µ –º–æ–≥ –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –ø–æ—Ä—Ç 443 –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª n8n.
**–†–µ—à–µ–Ω–∏–µ (Origin Rules):**
- –ë–æ—Ç –≤–Ω—É—Ç—Ä–∏ Docker —Å–ª—É—à–∞–µ—Ç **IPv4 `0.0.0.0`** –Ω–∞ –ø–æ—Ä—Ç—É `8080`.
- –í Cloudflare –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ **Origin Rule** –¥–ª—è –ø–æ–¥–¥–æ–º–µ–Ω–∞ `bot.indikov.ru`: –≤–µ—Å—å –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ —Å –ø–æ—Ä—Ç–∞ 443 –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º Cloudflare –Ω–∞ –ø–æ—Ä—Ç `8080` —Å–µ—Ä–≤–µ—Ä–∞.
- –î–ª—è n8n –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ: `n8n.indikov.ru` –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç `5678`.
- –í `.env` –±–æ—Ç—É –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–∏—Å—Ç—ã–π URL `https://bot.indikov.ru` (–±–µ–∑ –ø–æ—Ä—Ç–æ–≤), —Ç–∞–∫ –∫–∞–∫ –¢–µ–ª–µ–≥—Ä–∞–º –æ–±—â–∞–µ—Ç—Å—è —Å Cloudflare –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É 443.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ SSL
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ `525 SSL Handshake Failed` –∏–ª–∏ `521 Web server is down`.
**–†–µ—à–µ–Ω–∏–µ:** –í Cloudflare –¥–ª—è –≤—Å–µ–≥–æ –¥–æ–º–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º SSL/TLS: **Flexible**. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ç—Ä–∞—Ñ–∏–∫ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ Cloudflare –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω (HTTPS), –∞ –æ—Ç Cloudflare –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–¥–µ—Ç –ø–æ HTTP, —Ç–∞–∫ –∫–∞–∫ –≤–Ω—É—Ç—Ä–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–±–æ—Ç –∏ n8n) –Ω–µ—Ç SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.

### 3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ (–û–ó–£)
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ—Ä–≤–µ—Ä –∑–∞–≤–∏—Å–∞–ª (CPU 100%) –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç—è–∂–µ–ª—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (n8n).
**–†–µ—à–µ–Ω–∏–µ:** –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ–±–∞–≤–ª–µ–Ω Swap-—Ñ–∞–π–ª (—Ñ–∞–π–ª –ø–æ–¥–∫–∞—á–∫–∏) –Ω–∞ 2 –ì–ë. `vm.swappiness` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 10. –ü—Ä–∏ –¥–µ–ø–ª–æ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å `docker image prune -f` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –º–µ—Å—Ç–∞.

---

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ë–∞–≥–∏ (Core Logic)

### Fix 1: –û—à–∏–±–∫–∞ `Character '.' is reserved` (MarkdownV2)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —É—Ä–æ–∫–∞, –±–æ—Ç –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π Telegram API, —Ç–∞–∫ –∫–∞–∫ –≤ —Ç–µ–∫—Å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `parse_mode=ParseMode.MARKDOWN_V2`, –Ω–æ —Ç–æ—á–∫–∏ (`.`) –Ω–µ –±—ã–ª–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.
**–†–µ—à–µ–Ω–∏–µ:** –í —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_handle_missing_lesson_content` –∏ `send_to_user`) –æ—Ç–∫–ª—é—á–µ–Ω Markdown (`parse_mode=None`). –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MarkdownV2 —Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –∂–µ—Å—Ç–∫–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–µ–π `escape_md()`.

### Fix 2: –ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é (27.02.2026)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞ –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é, –∫–æ–º–∞–Ω–¥–∞ `/start` –ø–µ—Ä–µ—Å—Ç–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å. –û—à–∏–±–∫–∞:
```
TelegramBadRequest: can't parse entities: Can't find end of the entity starting at byte offset 524
```
**–ü—Ä–∏—á–∏–Ω–∞:** `GIT_VERSION` —Å–æ–¥–µ—Ä–∂–∞–ª —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/`, `-`, –ø—Ä–æ–±–µ–ª—ã), –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–º–∞–ª–∏ Markdown –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ–±—Ä–∞—Ç–Ω—ã—Ö –∫–∞–≤—ã—á–µ–∫ `` ` ``.

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±—Ä–∞–Ω—ã –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–æ–∫—Ä—É–≥ –≤–µ—Ä—Å–∏–∏: `` `{GIT_VERSION}` `` ‚Üí `{GIT_VERSION}`
- `parse_mode` –∏–∑–º–µ–Ω—ë–Ω —Å `"Markdown"` –Ω–∞ `None`
- –ë–æ—Ç —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã

**–£—Ä–æ–∫:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Markdown —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –º–æ–∂–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤. –î–ª—è –≤–µ—Ä—Å–∏–π –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî `parse_mode=None`.

### Fix 3: –û—à–∏–±–∫–∞ await –≤ get_next_lesson_time() (27.02.2026)
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `get_next_lesson_time()` –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Å `await`, –Ω–æ –æ–Ω–∞ –Ω–µ async.
```
TypeError: object str can't be used in 'await' expression
```
**–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞–Ω `await` –∏–∑ –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤:
- `send_main_menu()` (—Å—Ç—Ä–æ–∫–∞ ~9396)
- `handle_homework()` (—Å—Ç—Ä–æ–∫–∞ ~9025)
- `send_lesson_to_user()` (—Å—Ç—Ä–æ–∫–∞ ~1017)

**–£—Ä–æ–∫:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è async –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º await.

**–í–∞–∂–Ω–æ:** –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ –Ω—É–∂–Ω–æ **–ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –±–æ—Ç–∞** (`docker compose up -d --build`), –∏–Ω–∞—á–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞.

### Fix 4: –¢–∞–π–º–µ—Ä –î–ó –ø–æ–∫–∞–∑—ã–≤–∞–ª "0 —Å–µ–∫ –Ω–∞–∑–∞–¥" –≤–º–µ—Å—Ç–æ "34 —Å–µ–∫"
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–∞—á–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –±—ã–ª–æ "0 —Å–µ–∫ –Ω–∞–∑–∞–¥", —á—Ç–æ —Å–±–∏–≤–∞–ª–æ —Å —Ç–æ–ª–∫—É.

**–†–µ—à–µ–Ω–∏–µ (28.02.2026):**
- –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ "34 —Å–µ–∫" (–∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `HW_TIMEOUT_SECONDS`)
- –¢–∞–π–º–µ—Ä —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è: 34 —Å–µ–∫ ‚Üí 14 —Å–µ–∫ ‚Üí 0 —Å–µ–∫
- –ö–æ–≥–¥–∞ –≤—Ä–µ–º—è –≤—ã—à–ª–æ: "‚è≥ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞—á–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É –î–ó"

**–í–∞–∂–Ω–æ:** –¢–∞–π–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **–æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è**, –∞ –Ω–µ –ø—Ä–æ—à–µ–¥—à–µ–µ.

### Fix 5: n8n –æ—à–∏–±–∫–∞ 404 ‚Äî –±–æ—Ç –Ω–µ —Å–ª—É—à–∞–µ—Ç webhook
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ **POLLING** (`WEBHOOK_MODE=false`), –ø–æ—ç—Ç–æ–º—É –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook –∑–∞–ø—Ä–æ—Å—ã –æ—Ç n8n.

**–°–∏–º–ø—Ç–æ–º:**
```
AxiosError: Request failed with status code 404
URL: https://bot.indikov.ru/hwX9kLmPqR7tUvW2yZ5aBcDeFgHiJkL/n8n_hw_result
```

**–†–µ—à–µ–Ω–∏–µ (2 –≤–∞—Ä–∏–∞–Ω—Ç–∞):**

**–í–∞—Ä–∏–∞–Ω—Ç A: –í–∫–ª—é—á–∏—Ç—å webhook —Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
–í `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
WEBHOOK_MODE=true
```
–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: `docker compose restart bot`

**–í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π Docker URL**
–í `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
BOT_INTERNAL_URL=http://bot:8080
```
–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: `docker compose restart bot`

–¢–æ–≥–¥–∞ n8n –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `http://bot:8080/webhook/n8n_hw_result` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å Docker).

**–£—Ä–æ–∫:** –î–ª—è webhook callback –æ—Ç n8n –±–æ—Ç –¥–æ–ª–∂–µ–Ω —Å–ª—É—à–∞—Ç—å webhook URL (WEBHOOK_MODE=true) –ò–õ–ò –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π Docker URL.

### Fix 6: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (aiogram 3 Routing)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª –∫–æ–º–∞–Ω–¥—É `/upload_lesson` –∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∞. –ö–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª–∏—Å—å –æ–±—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º `handle_text` (–∫–æ—Ç–æ—Ä—ã–π –ª–æ–≤–∏—Ç `F.text`), –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ `UNHANDLED`, –Ω–æ –¥–∞–ª—å—à–µ –ø–æ —Ü–µ–ø–æ—á–∫–µ –Ω–µ —à–ª–∏.
**–†–µ—à–µ–Ω–∏–µ:**
1. –ù–∞—Å—Ç—Ä–æ–µ–Ω —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª–µ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑): –ö–æ–º–∞–Ω–¥—ã -> FSM -> –û–±—â–∏–µ (text/media).
2. –ù–∞ –æ–±—â–∏–π `handle_text` –∏ `handle_user_content` –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã:
   - `StateFilter(None)` ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —é–∑–µ—Ä –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞.
   - `~F.text.startswith('/')` ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ª—é–±—ã–µ –∫–æ–º–∞–Ω–¥—ã.

### Fix 4: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞ –≤ `/add_course`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–∞–Ω–¥–∞ –ø–∞–¥–∞–ª–∞ —Å –æ—à–∏–±–∫–æ–π `invalid literal for int()`, –µ—Å–ª–∏ –∞–¥–º–∏–Ω –∫–æ–ø–∏—Ä–æ–≤–∞–ª ID –≥—Ä—É–ø–ø—ã —Å –¥–≤—É–º—è —Ç–∏—Ä–µ (`--100...` –≤–º–µ—Å—Ç–æ `-100...`). –¢–∞–∫–∂–µ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–ª—é—á–∞ `price`.
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ `raw_group_id.lstrip("-")` —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –æ–¥–Ω–æ–≥–æ –º–∏–Ω—É—Å–∞. –í `settings["activation_codes"]` –∂–µ—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ `"price": 0`.

### Fix 5: –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (`NOT NULL constraint failed`)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ `/upload_lesson` –±–æ—Ç –ø–∞–¥–∞–ª, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–±–ª–∏—Ü–∞ `group_messages` —Ç—Ä–µ–±—É–µ—Ç `message_id`, –∞ –æ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è.
**–†–µ—à–µ–Ω–∏–µ:** –í SQL-–∑–∞–ø—Ä–æ—Å `INSERT INTO group_messages` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ `message.message_id` –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞.

### Fix 6: –û—à–∏–±–∫–∞ `charset` –≤ aiohttp (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Prometheus)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—ã–ø–∞–ª 500 –æ—à–∏–±–∫–∞–º–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ `/metrics`: `ValueError: charset must not be in content_type argument`.
**–†–µ—à–µ–Ω–∏–µ:** –í —Ñ–∞–π–ª–µ `services/metrics.py` –ø–∞—Ä–∞–º–µ—Ç—Ä `charset="utf-8"` –≤—ã–Ω–µ—Å–µ–Ω –∏–∑ —Å—Ç—Ä–æ–∫–∏ `content_type` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç `web.Response`, —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `aiohttp`.

---

## ü§ñ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n (–ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∞ –î–ó)

### 1. –ü—Ä–æ–±–ª–µ–º–∞ —Å "–≥—Ä—è–∑–Ω—ã–º" JSON (Red Nodes)
**–ü—Ä–æ–±–ª–µ–º–∞:** –£–∑–µ–ª *Agent* –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π —Ñ–æ—Ä–º—É–ª—ã, –µ—Å–ª–∏ –ü–∏—Ç–æ–Ω-–±–æ—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ —Ç–∞–π–º–∞—É—Ç—É). –ò–ò –ø–∏—Å–∞–ª –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è) –ø–æ–º–∏–º–æ JSON.
**–†–µ—à–µ–Ω–∏–µ:**
- –ù–∞–ø–∏—Å–∞–Ω "–±—Ä–æ–Ω–µ–±–æ–π–Ω—ã–π" –ø—Ä–æ–º–ø—Ç. –í n8n –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ñ–æ–ª–±—ç–∫–∞ –∏–º–µ–Ω–∏: `...user_fullname || ...student_name || '–°—Ç—É–¥–µ–Ω—Ç'`.
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫: –µ—Å–ª–∏ —É–∑–µ–ª `Merge` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª, –ò–ò –≤–∏–¥–∏—Ç –º–∞—Ä–∫–µ—Ä `[–ü–†–ò–ö–†–ï–ü–õ–ï–ù–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï]` –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ.

### 2. –ó–∞—Ç–∏—Ä–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram API
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –î–ó –Ω–∞ "–ò–ò –Ω–∞—á–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É", n8n –∑–∞—Ç–∏—Ä–∞–ª –≤—Å—ë —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –¥–æ–º–∞—à–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ Telegram API –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Ü–µ–ª–∏–∫–æ–º.
**–†–µ—à–µ–Ω–∏–µ:** –£–∑–µ–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É Python-–±–æ—Ç–∞. –í —Ñ—É–Ω–∫—Ü–∏–∏ `run_hw_countdown` –±–æ—Ç —Å–∞–º –º–µ–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫—É —Ç–∞–π–º–µ—Ä–∞ –Ω–∞ "–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç..." –∏ —É–±–∏—Ä–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ (`reply_markup=None`), –∫–æ–≥–¥–∞ —Ç–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫–∞–µ—Ç. –ò–∑ n8n —É–¥–∞–ª–µ–Ω —É–∑–µ–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram (–æ–Ω —Ç–æ–ª—å–∫–æ –¥—É–º–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç).

### 3. –û—à–∏–±–∫–∞ 404 –ø—Ä–∏ Callback –æ—Ç n8n
**–ü—Ä–æ–±–ª–µ–º–∞:** n8n –Ω–µ –º–æ–≥ –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ü–∏—Ç–æ–Ω-–±–æ—Ç—É, —Ç–∞–∫ –∫–∞–∫ –ø—ã—Ç–∞–ª—Å—è —Å—Ç—É—á–∞—Ç—å—Å—è –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É Docker URL (`http://bot:8080/webhook/...`), –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω.
**–†–µ—à–µ–Ω–∏–µ:** Python-–±–æ—Ç —Ç–µ–ø–µ—Ä—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤–Ω–µ—à–Ω–∏–π URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (`callback_webhook_url_result`) –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `.env` (`WEBHOOK_HOST` + `WEBHOOK_SECRET_PATH`) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ n8n –≤ —Ç–µ–ª–µ –≤–µ–±—Ö—É–∫–∞. –£–∑–µ–ª *HTTP Request* –≤ n8n –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ—Ç —ç—Ç–æ—Ç URL –∏ —à–ª–µ—Ç POST-–∑–∞–ø—Ä–æ—Å.

### 4. –ê–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ–µ –ò–ò (Auto-approve fallback)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ n8n –∏–ª–∏ OpenRouter –ª–æ–∂–∏–ª–∏—Å—å, –î–ó –≤–∏—Å–µ–ª–æ –≤–µ—á–Ω–æ –≤ —Å—Ç–∞—Ç—É—Å–µ "–æ–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏".
**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ 27.02.2026):**
- `check_pending_homework_timeout()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –î–ó –∫–∞–∂–¥—ã–µ **10 —Å–µ–∫—É–Ω–¥** (–±—ã–ª–æ 60).
- –ï—Å–ª–∏ –î–ó –≤–∏—Å–∏—Ç **3 √ó HW_TIMEOUT_SECONDS** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 102 —Å–µ–∫ –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ 34 —Å–µ–∫) ‚Üí –±–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `handle_homework_result()` —Å `is_approved=True`.
- –°—Ç—É–¥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç: "‚úÖ –í–∞—à–µ –î–ó –ø—Ä–∏–Ω—è—Ç–æ."
- –ê–¥–º–∏–Ω–∞–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "‚ö†Ô∏è –î–ó @username –æ–¥–æ–±—Ä–µ–Ω–æ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò (–ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ X –º–∏–Ω Y —Å–µ–∫)."
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏: `format_time_duration()` ‚Üí "34 —Å–µ–∫", "4 –º–∏–Ω 2 —Å–µ–∫", "2 —á 15 –º–∏–Ω".

### 5. –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —É—Ä–æ–∫–∞–º–∏ –∏–∑ settings.json (–Ω–µ —Ö–∞—Ä–¥–∫–æ–¥)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —É—Ä–æ–∫–∞–º–∏ –±—ã–ª –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω (12 —á–∞—Å–æ–≤ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, 5 –º–∏–Ω –¥–ª—è —Ç–µ—Å—Ç-—Ä–µ–∂–∏–º–∞). –ù–µ–ª—å–∑—è –±—ã–ª–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å –Ω–∞ –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö.

**–†–µ—à–µ–Ω–∏–µ (27.02.2026):**
- `message_interval` —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ `settings.json`
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥:
  - `0.03` ‚Üí "2 –º–∏–Ω"
  - `1` ‚Üí "1 —á–∞—Å"
  - `24` ‚Üí "24 —á"
- –í –∞–¥–º–∏–Ω-–º–µ–Ω—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è: "üïê –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —É—Ä–æ–∫–∞–º–∏: X –º–∏–Ω/—á–∞—Å–æ–≤"
- –í —Ç–µ—Å—Ç-—Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏–∑ settings

**–ü—Ä–∏–º–µ—Ä settings.json:**
```json
{
  "message_interval": 0.03  // 2 –º–∏–Ω—É—Ç—ã –º–µ–∂–¥—É —É—Ä–æ–∫–∞–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∞
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å (–ø–æ—Å—Ç–∞–≤–∏—Ç—å 2 –º–∏–Ω—É—Ç—ã)
- –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
- –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫—É—Ä—Å–æ–≤

### 6. –û—à–∏–±–∫–∞ 521 (Web server is down) –≤ n8n
**–ü—Ä–æ–±–ª–µ–º–∞:** n8n –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –î–ó –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç–∞. Cloudflare –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 521.

**–ü—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è (–ø–æ–¥—Ä–æ–±–Ω–æ):**

#### A. –ù–µ–≤–µ—Ä–Ω—ã–π callback URL –≤ payload
**–°–∏–º–ø—Ç–æ–º:** n8n —Å—Ç—É—á–∏—Ç—Å—è –Ω–µ —Ç—É–¥–∞.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
docker compose logs bot | grep "callback_base"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
callback_base (–≤–Ω–µ—à–Ω–∏–π): https://bot.indikov.ru/hwX9kLmPqR7tUvW2yZ5aBcDeFgHiJkL
n8n callback URL: https://bot.indikov.ru/hwX9kLmPqR7tUvW2yZ5aBcDeFgHiJkL/n8n_hw_result
```

**–ï—Å–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:** –ü—Ä–æ–≤–µ—Ä—å `.env`:
```bash
cat .env | grep WEBHOOK
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
WEBHOOK_HOST=https://bot.indikov.ru
WEBHOOK_SECRET_PATH=hwX9kLmPqR7tUvW2yZ5aBcDeFgHiJkL
WEBHOOK_PATH=/webhook
```

**–í –∫–æ–¥–µ –±–æ—Ç–∞ (main.py):**
```python
# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ callback URL
host = WEBHOOK_HOST_CONF.rstrip("/")
secret_path = (WEBHOOK_SECRET_PATH_CONF or "").strip("/")
callback_base = f"{host}/{secret_path}" if secret_path else f"{host}/bot/"
callback_url = f"{callback_base}/n8n_hw_result"
```

#### B. –°—Ç–∞—Ç–∏—á–Ω—ã–π URL –≤ –Ω–æ–¥–µ HTTP Request (n8n)
**–°–∏–º–ø—Ç–æ–º:** n8n –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç payload –∏ —à–ª–µ—Ç –Ω–∞ —Å—Ç–∞—Ä—ã–π URL.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
1. –û—Ç–∫—Ä–æ–π –≤–æ—Ä–∫—Ñ–ª–æ—É –≤ n8n
2. –ù–∞–π–¥–∏ –Ω–æ–¥—É **HTTP Request** (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–æ—Ç—É)
3. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª–µ **URL**

**‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:**
```
https://bot.indikov.ru/webhook/n8n_hw_result
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (Expression):**
```javascript
{{ $('Webhook-homework').item.json.body.callback_webhook_url_result }}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
1. –ö–ª–∏–∫–Ω–∏ –Ω–∞ –ø–æ–ª–µ URL
2. –ù–∞–∂–º–∏ `‚öôÔ∏è` ‚Üí "Add Expression" –∏–ª–∏ `{{}}`
3. –í—Å—Ç–∞–≤—å —Ñ–æ—Ä–º—É–ª—É –≤—ã—à–µ
4. –°–æ—Ö—Ä–∞–Ω–∏ –≤–æ—Ä–∫—Ñ–ª–æ—É

#### C. Cloudflare Origin Rules –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
**–°–∏–º–ø—Ç–æ–º:** Cloudflare –Ω–µ –∑–Ω–∞–µ—Ç –∫—É–¥–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
1. Cloudflare Dashboard ‚Üí Rules ‚Üí Origin Rules
2. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è `bot.indikov.ru`

**–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π:**
- **Rule name:** `Bot Redirect`
- **If hostname:** `equals` ‚Üí `bot.indikov.ru`
- **Destination port:** `Rewrite to` ‚Üí `8080`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –° –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã:
curl -I https://bot.indikov.ru/health/live
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å HTTP/2 200
```

#### D. –ë–æ—Ç —Å–ª—É—à–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ö–æ—Å—Ç
**–°–∏–º–ø—Ç–æ–º:** Docker –Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
docker compose logs bot | grep "–ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
–ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: 8080
```

**–ü—Ä–æ–≤–µ—Ä—å `.env`:**
```
WEBAPP_HOST=0.0.0.0  # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û! –ù–µ localhost, –Ω–µ 127.0.0.1
WEB_SERVER_PORT=8080
```

**–í docker-compose.yml:**
```yaml
services:
  bot:
    ports:
      - "8080:8080"  # –ü—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞
```

#### E. N8N_CALLBACK_SECRET –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
**–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å 403 Forbidden.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –í .env –±–æ—Ç–∞:
cat .env | grep N8N_CALLBACK_SECRET

# –í n8n (–Ω–æ–¥–∞ HTTP Request ‚Üí Headers):
X-CALLBACK-SIGNATURE: 500
```

**–î–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å!**

**–†–µ—à–µ–Ω–∏–µ:**
1. –í `.env` –±–æ—Ç–∞: `N8N_CALLBACK_SECRET=500`
2. –í n8n HTTP Request ‚Üí Headers:
   - Name: `X-CALLBACK-SIGNATURE`
   - Value: `=500` (–∏–ª–∏ Expression: `={{ '500' }}`)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ callback –æ—Ç n8n

**–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –î–ó**
```bash
docker compose logs -f bot | grep -E "callback|n8n"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
üì§ –î–ó #123 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ n8n (–≤–æ–∑—Ä–∞—Å—Ç: 34 —Å–µ–∫)
callback_base (–≤–Ω–µ—à–Ω–∏–π): https://bot.indikov.ru/hwX9kLmPqR7tUvW2yZ5aBcDeFgHiJkL
n8n callback URL: https://bot.indikov.ru/hwX9kLmPqR7tUvW2yZ5aBcDeFgHiJkL/n8n_hw_result
```

**–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ n8n**
```bash
docker compose logs n8n | grep -E "POST|webhook"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
"POST /webhook/aa46a723-619e-42e9-8e51-49ba51813718" 200
"POST https://bot.indikov.ru/hwX9kLmPqR7tUvW2yZ5aBcDeFgHiJkL/n8n_hw_result" 200
```

**–®–∞–≥ 3: –†—É—á–Ω–æ–π —Ç–µ—Å—Ç webhook**
```bash
# –° —Å–µ—Ä–≤–µ—Ä–∞ (vps):
curl -X POST https://bot.indikov.ru/hwX9kLmPqR7tUvW2yZ5aBcDeFgHiJkL/n8n_hw_result \
  -H "Content-Type: application/json" \
  -H "X-CALLBACK-SIGNATURE: 500" \
  -d '{"feedback_text":"–¢–µ—Å—Ç","is_approved":true,"student_user_id":123}'

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 200 OK
```

---

## üìù TODO / –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- [ ] *–ó–∞–ø–æ–ª–Ω–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–¥–µ–∏, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ*


***




## üõ† –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ (DevOps & Server Setup)

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (Debian 12), Docker –∏ Cloudflare, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞.

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare (–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ SSL)

–ü–æ—Å–∫–æ–ª—å–∫—É –Ω–∞ –æ–¥–Ω–æ–º IP-–∞–¥—Ä–µ—Å–µ —Ä–∞–±–æ—Ç–∞—é—Ç –¥–≤–∞ –≤–µ–±-—Å–µ—Ä–≤–∏—Å–∞ (–ë–æ—Ç –∏ n8n), –∏ –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º Nginx/Traefik –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–µ–≤–µ—Ä—Å-–ø—Ä–æ–∫—Å–∏, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ **–Ω–∞ —É—Ä–æ–≤–Ω–µ Cloudflare**.

**A. DNS Records:**
- `bot.indikov.ru` -> A-–∑–∞–ø–∏—Å—å –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞ (Proxy status: üü† Proxied)
- `n8n.indikov.ru` -> A-–∑–∞–ø–∏—Å—å –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞ (Proxy status: üü† Proxied)

**B. SSL/TLS:**
- **–†–µ–∂–∏–º:** `Flexible` (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!). 
- *–ü—Ä–∏—á–∏–Ω–∞:* Cloudflare –æ–±—â–∞–µ—Ç—Å—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –ø–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º—É HTTPS (–ø–æ—Ä—Ç 443), –Ω–æ –Ω–∞ —Å–∞–º —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥–∞–µ—Ç –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π HTTP —Ç—Ä–∞—Ñ–∏–∫. –í–Ω—É—Ç—Ä–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ—Ç SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤. –ï—Å–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å "Full", —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫—É `525 SSL Handshake Failed`.

**C. Origin Rules (–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è):**
*(–ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –º–µ–Ω—é: Rules -> Origin Rules)*
Cloudflare –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ 443 –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Ä—Ç—ã Docker.
1. **Rule "Bot Redirect":** If `Hostname` equals `bot.indikov.ru` -> Destination Port: `Rewrite to 8080`.
2. **Rule "N8N Redirect":** If `Hostname` equals `n8n.indikov.ru` -> Destination Port: `Rewrite to 5678`.

---

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –°–µ—Ä–≤–µ—Ä–∞ (Debian)

**A. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firewall (UFW):**
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç—ã. –í–∫–ª—é—á–µ–Ω UFW:
```bash
sudo apt install ufw -y
sudo ufw allow 22/tcp    # SSH (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø)
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 8080/tcp  # –ë–æ—Ç (–≤–Ω–µ—à–Ω–∏–π)
sudo ufw allow 5678/tcp  # n8n (–≤–Ω–µ—à–Ω–∏–π)
sudo ufw enable
```

**B. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ (Swap-—Ñ–∞–π–ª):**
*–ü—Ä–æ–±–ª–µ–º–∞:* –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å 1 –ì–ë –û–ó–£ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ n8n –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –ø–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (CPU 100%), —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–∏—Å–∞–ª –∏ –ø–∞–¥–∞–ª —Å OOM (Out Of Memory).
*–†–µ—à–µ–Ω–∏–µ:* –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –ø–æ–¥–∫–∞—á–∫–∏ –Ω–∞ 2 –ì–ë.
```bash
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å swap —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
sudo sysctl vm.swappiness=10
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
```

---

### 3. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ `.env` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

**A. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö–æ—Å—Ç–∞:**
- `WEBAPP_HOST=0.0.0.0` ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è Docker. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å, aiohttp –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å `::1` (IPv6 localhost), –∏ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ –∏–∑ Docker-compose —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç (`curl: (52) Empty reply from server`).
- `WEBHOOK_HOST=https://bot.indikov.ru` ‚Äî –ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ—Ä—Ç–æ–≤! –¢–µ–ª–µ–≥—Ä–∞–º —Å—Ç—É—á–∏—Ç—Å—è –≤ Cloudflare –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É 443 –ø–æ—Ä—Ç—É.

**B. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n:**
- `N8N_CALLBACK_SECRET` ‚Äî –ø–∞—Ä–æ–ª—å, –∫–æ—Ç–æ—Ä—ã–π n8n –ø–µ—Ä–µ–¥–∞–µ—Ç –±–æ—Ç—É –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-CALLBACK-SIGNATURE` –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –î–ó.

---

### 4. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –Ω–µ–ø–æ–ª–∞–¥–æ–∫ (Troubleshooting)

**A. –û—à–∏–±–∫–∞ `OSError:[Errno 28] No space left on device`**
–°–µ—Ä–≤–µ—Ä –∑–∞–±–∏–ª—Å—è –ª–æ–≥–∞–º–∏ –∏ —Å—Ç–∞—Ä—ã–º–∏ –æ–±—Ä–∞–∑–∞–º–∏ Docker.
*–†–µ—à–µ–Ω–∏–µ:* 
```bash
docker system prune -a -f    # –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã –∏ –∫—ç—à
sudo apt-get clean           # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤
sudo journalctl --vacuum-time=1d # –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤
```

**B. –£–ø–∞–ª–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö n8n (`SQLITE_ERROR: no such column...`)**
–ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä—É –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –º–µ—Å—Ç–∞/–ø–∞–º—è—Ç–∏ –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î n8n.
*–†–µ—à–µ–Ω–∏–µ (—Å–±—Ä–æ—Å –ë–î, –≤–æ—Ä–∫—Ñ–ª–æ—É —É–¥–∞–ª—è—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –∑–∞–±—ç–∫–∞–ø–ª–µ–Ω—ã):*
```bash
docker-compose down
sudo rm -rf n8n_data/*
docker-compose up -d
```

**C. –û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ n8n (`Permission denied`)**
–ü–∞–ø–∫–∞ `n8n_data` –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (ID 1000).
*–†–µ—à–µ–Ω–∏–µ:*
```bash
sudo chown -R 1000:1000 n8n_data
sudo chmod -R 777 n8n_data
```

**D. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç "–£—Ä–æ–∫ ‚ÑñX –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", —Ö–æ—Ç—è –æ–Ω –µ—Å—Ç—å –≤ –±–∞–∑–µ**
–û–±—ã—á–Ω–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ –∞–¥–º–∏–Ω –∑–∞–≥—Ä—É–∑–∏–ª —É—Ä–æ–∫, –Ω–∞—Ö–æ–¥—è—Å—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç). 
*–†–µ—à–µ–Ω–∏–µ:* –í—ã–ø–æ–ª–Ω–∏—Ç—å `/admin_reset` –≤ –ª–∏—á–∫–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `user_courses` –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã.












