
# AntBot v4 - –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥ –ø—Ä–∏–Ω—è—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–∞–≥–æ–≤ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞.
**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ö –ü–†–û–ß–¢–ï–ù–ò–Æ** –ø–µ—Ä–µ–¥ –≤–Ω–µ—Å–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥ –∏–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.

---

## üèóÔ∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ –ü–æ—Ä—Ç—ã (Docker + Cloudflare)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –∏ n8n –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ. n8n –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç—ã 80 –∏ 443. –¢–µ–ª–µ–≥—Ä–∞–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–±—Ö—É–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤ (443, 80, 8443, 88). –ë–æ—Ç –Ω–µ –º–æ–≥ –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –ø–æ—Ä—Ç 443 –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª n8n.
**–†–µ—à–µ–Ω–∏–µ (Origin Rules):**
- –ë–æ—Ç –≤–Ω—É—Ç—Ä–∏ Docker —Å–ª—É—à–∞–µ—Ç **IPv4 `0.0.0.0`** –Ω–∞ –ø–æ—Ä—Ç—É `8080`.
- –í Cloudflare –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ **Origin Rule** –¥–ª—è –ø–æ–¥–¥–æ–º–µ–Ω–∞ `bot.indikov.ru`: –≤–µ—Å—å –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ —Å –ø–æ—Ä—Ç–∞ 443 –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º Cloudflare –Ω–∞ –ø–æ—Ä—Ç `8080` —Å–µ—Ä–≤–µ—Ä–∞.
- –î–ª—è n8n –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ: `n8n.indikov.ru` –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç `5678`.
- –í `.env` –±–æ—Ç—É –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–∏—Å—Ç—ã–π URL `https://bot.indikov.ru` (–±–µ–∑ –ø–æ—Ä—Ç–æ–≤), —Ç–∞–∫ –∫–∞–∫ –¢–µ–ª–µ–≥—Ä–∞–º –æ–±—â–∞–µ—Ç—Å—è —Å Cloudflare –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É 443.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ SSL
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ `525 SSL Handshake Failed` –∏–ª–∏ `521 Web server is down`.
**–†–µ—à–µ–Ω–∏–µ:** –í Cloudflare –¥–ª—è –≤—Å–µ–≥–æ –¥–æ–º–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º SSL/TLS: **Flexible**. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ç—Ä–∞—Ñ–∏–∫ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ Cloudflare –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω (HTTPS), –∞ –æ—Ç Cloudflare –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–¥–µ—Ç –ø–æ HTTP, —Ç–∞–∫ –∫–∞–∫ –≤–Ω—É—Ç—Ä–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–±–æ—Ç –∏ n8n) –Ω–µ—Ç SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.

### 3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ (–û–ó–£)
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ—Ä–≤–µ—Ä –∑–∞–≤–∏—Å–∞–ª (CPU 100%) –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç—è–∂–µ–ª—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (n8n).
**–†–µ—à–µ–Ω–∏–µ:** –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ–±–∞–≤–ª–µ–Ω Swap-—Ñ–∞–π–ª (—Ñ–∞–π–ª –ø–æ–¥–∫–∞—á–∫–∏) –Ω–∞ 2 –ì–ë. `vm.swappiness` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 10. –ü—Ä–∏ –¥–µ–ø–ª–æ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å `docker image prune -f` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –º–µ—Å—Ç–∞.

---

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ë–∞–≥–∏ (Core Logic)

### Fix 1: –û—à–∏–±–∫–∞ `Character '.' is reserved` (MarkdownV2)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —É—Ä–æ–∫–∞, –±–æ—Ç –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π Telegram API, —Ç–∞–∫ –∫–∞–∫ –≤ —Ç–µ–∫—Å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `parse_mode=ParseMode.MARKDOWN_V2`, –Ω–æ —Ç–æ—á–∫–∏ (`.`) –Ω–µ –±—ã–ª–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.
**–†–µ—à–µ–Ω–∏–µ:** –í —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_handle_missing_lesson_content` –∏ `send_to_user`) –æ—Ç–∫–ª—é—á–µ–Ω Markdown (`parse_mode=None`). –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MarkdownV2 —Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –∂–µ—Å—Ç–∫–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–µ–π `escape_md()`.

### Fix 2: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (aiogram 3 Routing)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª –∫–æ–º–∞–Ω–¥—É `/upload_lesson` –∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∞. –ö–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª–∏—Å—å –æ–±—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º `handle_text` (–∫–æ—Ç–æ—Ä—ã–π –ª–æ–≤–∏—Ç `F.text`), –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ `UNHANDLED`, –Ω–æ –¥–∞–ª—å—à–µ –ø–æ —Ü–µ–ø–æ—á–∫–µ –Ω–µ —à–ª–∏.
**–†–µ—à–µ–Ω–∏–µ:**
1. –ù–∞—Å—Ç—Ä–æ–µ–Ω —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª–µ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑): –ö–æ–º–∞–Ω–¥—ã -> FSM -> –û–±—â–∏–µ (text/media).
2. –ù–∞ –æ–±—â–∏–π `handle_text` –∏ `handle_user_content` –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã:
   - `StateFilter(None)` ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —é–∑–µ—Ä –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞.
   - `~F.text.startswith('/')` ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ª—é–±—ã–µ –∫–æ–º–∞–Ω–¥—ã.

### Fix 3: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞ –≤ `/add_course`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–∞–Ω–¥–∞ –ø–∞–¥–∞–ª–∞ —Å –æ—à–∏–±–∫–æ–π `invalid literal for int()`, –µ—Å–ª–∏ –∞–¥–º–∏–Ω –∫–æ–ø–∏—Ä–æ–≤–∞–ª ID –≥—Ä—É–ø–ø—ã —Å –¥–≤—É–º—è —Ç–∏—Ä–µ (`--100...` –≤–º–µ—Å—Ç–æ `-100...`). –¢–∞–∫–∂–µ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–ª—é—á–∞ `price`.
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ `raw_group_id.lstrip("-")` —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –æ–¥–Ω–æ–≥–æ –º–∏–Ω—É—Å–∞. –í `settings["activation_codes"]` –∂–µ—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ `"price": 0`.

### Fix 4: –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (`NOT NULL constraint failed`)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ `/upload_lesson` –±–æ—Ç –ø–∞–¥–∞–ª, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–±–ª–∏—Ü–∞ `group_messages` —Ç—Ä–µ–±—É–µ—Ç `message_id`, –∞ –æ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è.
**–†–µ—à–µ–Ω–∏–µ:** –í SQL-–∑–∞–ø—Ä–æ—Å `INSERT INTO group_messages` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ `message.message_id` –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞.

### Fix 5: –û—à–∏–±–∫–∞ `charset` –≤ aiohttp (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Prometheus)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—ã–ø–∞–ª 500 –æ—à–∏–±–∫–∞–º–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ `/metrics`: `ValueError: charset must not be in content_type argument`.
**–†–µ—à–µ–Ω–∏–µ:** –í —Ñ–∞–π–ª–µ `services/metrics.py` –ø–∞—Ä–∞–º–µ—Ç—Ä `charset="utf-8"` –≤—ã–Ω–µ—Å–µ–Ω –∏–∑ —Å—Ç—Ä–æ–∫–∏ `content_type` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç `web.Response`, —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `aiohttp`.

---

## ü§ñ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n (–ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∞ –î–ó)

### 1. –ü—Ä–æ–±–ª–µ–º–∞ —Å "–≥—Ä—è–∑–Ω—ã–º" JSON (Red Nodes)
**–ü—Ä–æ–±–ª–µ–º–∞:** –£–∑–µ–ª *Agent* –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π —Ñ–æ—Ä–º—É–ª—ã, –µ—Å–ª–∏ –ü–∏—Ç–æ–Ω-–±–æ—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ —Ç–∞–π–º–∞—É—Ç—É). –ò–ò –ø–∏—Å–∞–ª –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è) –ø–æ–º–∏–º–æ JSON.
**–†–µ—à–µ–Ω–∏–µ:** 
- –ù–∞–ø–∏—Å–∞–Ω "–±—Ä–æ–Ω–µ–±–æ–π–Ω—ã–π" –ø—Ä–æ–º–ø—Ç. –í n8n –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ñ–æ–ª–±—ç–∫–∞ –∏–º–µ–Ω–∏: `...user_fullname || ...student_name || '–°—Ç—É–¥–µ–Ω—Ç'`.
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫: –µ—Å–ª–∏ —É–∑–µ–ª `Merge` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª, –ò–ò –≤–∏–¥–∏—Ç –º–∞—Ä–∫–µ—Ä `[–ü–†–ò–ö–†–ï–ü–õ–ï–ù–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï]` –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ.

### 2. –ó–∞—Ç–∏—Ä–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram API
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –î–ó –Ω–∞ "–ò–ò –Ω–∞—á–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É", n8n –∑–∞—Ç–∏—Ä–∞–ª –≤—Å—ë —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –¥–æ–º–∞—à–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ Telegram API –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Ü–µ–ª–∏–∫–æ–º.
**–†–µ—à–µ–Ω–∏–µ:** –£–∑–µ–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É Python-–±–æ—Ç–∞. –í —Ñ—É–Ω–∫—Ü–∏–∏ `run_hw_countdown` –±–æ—Ç —Å–∞–º –º–µ–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫—É —Ç–∞–π–º–µ—Ä–∞ –Ω–∞ "–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç..." –∏ —É–±–∏—Ä–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ (`reply_markup=None`), –∫–æ–≥–¥–∞ —Ç–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫–∞–µ—Ç. –ò–∑ n8n —É–¥–∞–ª–µ–Ω —É–∑–µ–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram (–æ–Ω —Ç–æ–ª—å–∫–æ –¥—É–º–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç).

### 3. –û—à–∏–±–∫–∞ 404 –ø—Ä–∏ Callback –æ—Ç n8n
**–ü—Ä–æ–±–ª–µ–º–∞:** n8n –Ω–µ –º–æ–≥ –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ü–∏—Ç–æ–Ω-–±–æ—Ç—É, —Ç–∞–∫ –∫–∞–∫ –ø—ã—Ç–∞–ª—Å—è —Å—Ç—É—á–∞—Ç—å—Å—è –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É Docker URL (`http://bot:8080/webhook/...`), –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω.
**–†–µ—à–µ–Ω–∏–µ:** Python-–±–æ—Ç —Ç–µ–ø–µ—Ä—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤–Ω–µ—à–Ω–∏–π URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (`callback_webhook_url_result`) –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `.env` (`WEBHOOK_HOST` + `WEBHOOK_SECRET_PATH`) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ n8n –≤ —Ç–µ–ª–µ –≤–µ–±—Ö—É–∫–∞. –£–∑–µ–ª *HTTP Request* –≤ n8n –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ—Ç —ç—Ç–æ—Ç URL –∏ —à–ª–µ—Ç POST-–∑–∞–ø—Ä–æ—Å.

---

## üìù TODO / –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- [ ] *–ó–∞–ø–æ–ª–Ω–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–¥–µ–∏, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ*


***




## üõ† –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ (DevOps & Server Setup)

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (Debian 12), Docker –∏ Cloudflare, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞.

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare (–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ SSL)

–ü–æ—Å–∫–æ–ª—å–∫—É –Ω–∞ –æ–¥–Ω–æ–º IP-–∞–¥—Ä–µ—Å–µ —Ä–∞–±–æ—Ç–∞—é—Ç –¥–≤–∞ –≤–µ–±-—Å–µ—Ä–≤–∏—Å–∞ (–ë–æ—Ç –∏ n8n), –∏ –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º Nginx/Traefik –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–µ–≤–µ—Ä—Å-–ø—Ä–æ–∫—Å–∏, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ **–Ω–∞ —É—Ä–æ–≤–Ω–µ Cloudflare**.

**A. DNS Records:**
- `bot.indikov.ru` -> A-–∑–∞–ø–∏—Å—å –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞ (Proxy status: üü† Proxied)
- `n8n.indikov.ru` -> A-–∑–∞–ø–∏—Å—å –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞ (Proxy status: üü† Proxied)

**B. SSL/TLS:**
- **–†–µ–∂–∏–º:** `Flexible` (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!). 
- *–ü—Ä–∏—á–∏–Ω–∞:* Cloudflare –æ–±—â–∞–µ—Ç—Å—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –ø–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º—É HTTPS (–ø–æ—Ä—Ç 443), –Ω–æ –Ω–∞ —Å–∞–º —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥–∞–µ—Ç –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π HTTP —Ç—Ä–∞—Ñ–∏–∫. –í–Ω—É—Ç—Ä–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ—Ç SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤. –ï—Å–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å "Full", —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫—É `525 SSL Handshake Failed`.

**C. Origin Rules (–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è):**
*(–ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –º–µ–Ω—é: Rules -> Origin Rules)*
Cloudflare –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ 443 –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Ä—Ç—ã Docker.
1. **Rule "Bot Redirect":** If `Hostname` equals `bot.indikov.ru` -> Destination Port: `Rewrite to 8080`.
2. **Rule "N8N Redirect":** If `Hostname` equals `n8n.indikov.ru` -> Destination Port: `Rewrite to 5678`.

---

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –°–µ—Ä–≤–µ—Ä–∞ (Debian)

**A. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firewall (UFW):**
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç—ã. –í–∫–ª—é—á–µ–Ω UFW:
```bash
sudo apt install ufw -y
sudo ufw allow 22/tcp    # SSH (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø)
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 8080/tcp  # –ë–æ—Ç (–≤–Ω–µ—à–Ω–∏–π)
sudo ufw allow 5678/tcp  # n8n (–≤–Ω–µ—à–Ω–∏–π)
sudo ufw enable
```

**B. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ (Swap-—Ñ–∞–π–ª):**
*–ü—Ä–æ–±–ª–µ–º–∞:* –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å 1 –ì–ë –û–ó–£ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ n8n –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –ø–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (CPU 100%), —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–∏—Å–∞–ª –∏ –ø–∞–¥–∞–ª —Å OOM (Out Of Memory).
*–†–µ—à–µ–Ω–∏–µ:* –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –ø–æ–¥–∫–∞—á–∫–∏ –Ω–∞ 2 –ì–ë.
```bash
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å swap —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
sudo sysctl vm.swappiness=10
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
```

---

### 3. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ `.env` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

**A. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö–æ—Å—Ç–∞:**
- `WEBAPP_HOST=0.0.0.0` ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è Docker. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å, aiohttp –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å `::1` (IPv6 localhost), –∏ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ –∏–∑ Docker-compose —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç (`curl: (52) Empty reply from server`).
- `WEBHOOK_HOST=https://bot.indikov.ru` ‚Äî –ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ—Ä—Ç–æ–≤! –¢–µ–ª–µ–≥—Ä–∞–º —Å—Ç—É—á–∏—Ç—Å—è –≤ Cloudflare –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É 443 –ø–æ—Ä—Ç—É.

**B. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n:**
- `N8N_CALLBACK_SECRET` ‚Äî –ø–∞—Ä–æ–ª—å, –∫–æ—Ç–æ—Ä—ã–π n8n –ø–µ—Ä–µ–¥–∞–µ—Ç –±–æ—Ç—É –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-CALLBACK-SIGNATURE` –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –î–ó.

---

### 4. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –Ω–µ–ø–æ–ª–∞–¥–æ–∫ (Troubleshooting)

**A. –û—à–∏–±–∫–∞ `OSError:[Errno 28] No space left on device`**
–°–µ—Ä–≤–µ—Ä –∑–∞–±–∏–ª—Å—è –ª–æ–≥–∞–º–∏ –∏ —Å—Ç–∞—Ä—ã–º–∏ –æ–±—Ä–∞–∑–∞–º–∏ Docker.
*–†–µ—à–µ–Ω–∏–µ:* 
```bash
docker system prune -a -f    # –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã –∏ –∫—ç—à
sudo apt-get clean           # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤
sudo journalctl --vacuum-time=1d # –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤
```

**B. –£–ø–∞–ª–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö n8n (`SQLITE_ERROR: no such column...`)**
–ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä—É –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –º–µ—Å—Ç–∞/–ø–∞–º—è—Ç–∏ –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î n8n.
*–†–µ—à–µ–Ω–∏–µ (—Å–±—Ä–æ—Å –ë–î, –≤–æ—Ä–∫—Ñ–ª–æ—É —É–¥–∞–ª—è—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –∑–∞–±—ç–∫–∞–ø–ª–µ–Ω—ã):*
```bash
docker-compose down
sudo rm -rf n8n_data/*
docker-compose up -d
```

**C. –û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ n8n (`Permission denied`)**
–ü–∞–ø–∫–∞ `n8n_data` –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (ID 1000).
*–†–µ—à–µ–Ω–∏–µ:*
```bash
sudo chown -R 1000:1000 n8n_data
sudo chmod -R 777 n8n_data
```

**D. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç "–£—Ä–æ–∫ ‚ÑñX –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", —Ö–æ—Ç—è –æ–Ω –µ—Å—Ç—å –≤ –±–∞–∑–µ**
–û–±—ã—á–Ω–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ –∞–¥–º–∏–Ω –∑–∞–≥—Ä—É–∑–∏–ª —É—Ä–æ–∫, –Ω–∞—Ö–æ–¥—è—Å—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç). 
*–†–µ—à–µ–Ω–∏–µ:* –í—ã–ø–æ–ª–Ω–∏—Ç—å `/admin_reset` –≤ –ª–∏—á–∫–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `user_courses` –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã.












