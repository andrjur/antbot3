# –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ AntBot v4

## üö® –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### 1. –î–≤–æ–π–Ω–æ–π callback –æ—Ç n8n
**–ü—Ä–æ–±–ª–µ–º–∞:** n8n –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –î–í–ê –∑–∞–ø—Ä–æ—Å–∞:
1. `{'status': 'processing', ...}` ‚Äî –±–µ–∑ `is_approved`
2. `{'is_approved': True, 'feedback_text': '...'}` ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ `is_approved=False` ‚Üí –î–ó –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è: "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏"

**–†–µ—à–µ–Ω–∏–µ:**
- –í–∞—Ä–∏–∞–Ω—Ç A: –£–¥–∞–ª–∏—Ç—å HTTP Request1 –∏–∑ n8n (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ processing)
- –í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `status` –≤ –±–æ—Ç–µ (—Å—Ä–æ—á–Ω–æ!)

---

### 2. –ö–æ–¥ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ `git pull` + `docker compose restart` –∫–æ–¥ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.

**–ü—Ä–∏—á–∏–Ω–∞:** Docker –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
git reset --hard origin/main
docker compose down
docker compose up -d --build
```

---

### 3. –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ò–ò –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç—É–¥–µ–Ω—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç –ò–ò.

**–ü—Ä–∏—á–∏–Ω–∞:** `handle_homework_result` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã, –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `status=processing` (—Å–º. –ø—É–Ω–∫—Ç 1).

---

## üìã –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É callback –æ—Ç n8n

**–§–∞–π–ª:** `main.py`, —Ñ—É–Ω–∫—Ü–∏—è `handle_n8n_hw_approval()`

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `status=processing` –≤ –°–ê–ú–û–ú –ù–ê–ß–ê–õ–ï
2. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: `status=..., is_approved=...`
3. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `is_processing` –¥–ª—è —è–≤–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è

**–ö–æ–¥:**
```python
if data.get("status") == "processing":
    logger.info("üîπ –°—Ç–∞—Ç—É—Å processing - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º")
    return web.Response(text="OK", status=200)

logger.info("üîπ –°—Ç–∞—Ç—É—Å NOT processing - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º")
```

---

### –ü—Ä–∏–æ—Ä–∏—Ç 2: –£–ø—Ä–æ—Å—Ç–∏—Ç—å workflow –≤ n8n

**–§–∞–π–ª:** `AI_n8n.json`

**–ó–∞–¥–∞—á–∏:**
1. ‚è≥ –£–¥–∞–ª–∏—Ç—å HTTP Request1 (processing status)
2. ‚è≥ –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ HTTP Request (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
3. ‚è≥ –¢–∞–π–º–µ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç –±–æ—Ç (—á–µ—Ä–µ–∑ `run_hw_countdown`)

**–ü–æ—á–µ–º—É:** –ú–µ–Ω—å—à–µ –Ω–æ–¥ = –º–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫.

---

### –ü—Ä–∏–æ—Ä–∏—Ç 3: –†–∞–∑–¥–µ–ª–∏—Ç—å UI –æ–ø–µ—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `main.py`, —Ñ—É–Ω–∫—Ü–∏—è `handle_homework_result()`

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º `try...except`
2. ‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ò–ò —Å—Ç—É–¥–µ–Ω—Ç—É (–¥–æ 240 —Å–∏–º–≤–æ–ª–æ–≤)
3. ‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ò–ò –∞–¥–º–∏–Ω–∞–º (reply –Ω–∞ –î–ó)

**–ö–æ–¥:**
```python
# –£–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
try:
    await bot.edit_message_reply_markup(..., reply_markup=None)
except Exception:
    pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
feedback_short = feedback_text[:240] + "..." if len(feedback_text) > 240 else feedback_text
await bot.send_message(..., text=feedback_short)
```

---

### –ü—Ä–∏–æ—Ä–∏—Ç 4: –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª:** `main.py`

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ 8 –ª–æ–≥–æ–≤ –≤ `handle_n8n_hw_approval()`
2. ‚è≥ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `handle_homework_result()`:
   - "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç—É"
   - "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∞–¥–º–∏–Ω–∞–º"
   - "–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ pending_admin_homework"
3. ‚è≥ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞:
   - "–¢–∞–π–º–µ—Ä: 34 —Å–µ–∫ ‚Üí 24 —Å–µ–∫"
   - "–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: 10 —Å–µ–∫ ‚Üí 20 —Å–µ–∫"

---

### –ü—Ä–∏–æ—Ä–∏—Ç 5: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–§–∞–π–ª:** `deploy.sh` (–Ω–æ–≤—ã–π)

**–ó–∞–¥–∞—á–∏:**
1. ‚è≥ –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è:
   ```bash
   #!/bin/bash
   git fetch origin
   git reset --hard origin/main
   docker compose down
   docker compose up -d --build
   docker compose logs -f bot | tail -50
   ```
2. ‚è≥ Cron –¥–ª—è –∞–≤—Ç–æ–¥–µ–ø–ª–æ—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

**–§–∞–π–ª—ã:**
- `GOALS2.md` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (Fix 10, Fix 11)
- `CLAUDE.md` ‚Äî –≤–∞–∂–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏
- `N8N_SETUP.md` ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ n8n
- `REFACTORING_PLAN.md` ‚Äî —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## ‚úÖ –ß–¢–û –£–ñ–ï –°–î–ï–õ–ê–ù–û

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `status=processing` –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ 8 –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ UI –æ–ø–µ—Ä–∞—Ü–∏–π (–∫–Ω–æ–ø–∫–∏/—Å–æ–æ–±—â–µ–Ω–∏–µ)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (GOALS2.md, N8N_SETUP.md)

---

## ‚è≥ –ß–¢–û –û–°–¢–ê–õ–û–°–¨

- ‚è≥ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (git reset --hard)
- ‚è≥ –£–¥–∞–ª–∏—Ç—å HTTP Request1 –∏–∑ n8n
- ‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ò–ò —Å—Ç—É–¥–µ–Ω—Ç—É (–¥–æ 240 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚è≥ –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è `deploy.sh`

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

```
–°—Ç—É–¥–µ–Ω—Ç ‚Üí –î–ó ‚Üí –ë–æ—Ç ‚Üí n8n (–ò–ò) ‚Üí –ë–æ—Ç ‚Üí –°—Ç—É–¥–µ–Ω—Ç + –ê–¥–º–∏–Ω—ã
                ‚Üì
          –¢–∞–π–º–µ—Ä (34 —Å–µ–∫)
                ‚Üì
          –ê–≤—Ç–æ-–æ–¥–æ–±—Ä–µ–Ω–∏–µ (102 —Å–µ–∫)
```

**–ü—Ä–∞–≤–∏–ª–∞:**
1. n8n –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¢–û–õ–¨–ö–û —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
2. –ë–æ—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–∞–π–º–µ—Ä–æ–º —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
3. –¢–µ–∫—Å—Ç –ò–ò —É—Ä–µ–∑–∞–µ—Ç—Å—è –¥–æ 240 —Å–∏–º–≤–æ–ª–æ–≤
4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
