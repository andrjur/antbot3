#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è AntBot v4
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh [restore]

echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è AntBot v4..."

# 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose down

# 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git fetch origin
git reset --hard origin/main

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é
echo "üìã –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:"
git log -1 --oneline

# 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if [ "$1" == "restore" ] && [ -f "bot.db.backup" ]; then
    echo "üíæ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ bot.db.backup..."
    cp bot.db.backup bot.db
    echo "‚úÖ –ë–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
fi

# 5. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Å –Ω—É–ª—è
echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose up -d --build

# 6. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏
echo "üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
docker compose logs bot | tail -30

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
echo ""
echo "üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:"
echo "   ./deploy.sh         - –æ–±—ã—á–Ω—ã–π –¥–µ–ø–ª–æ–π"
echo "   ./deploy.sh restore - –¥–µ–ø–ª–æ–π + –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –∏–∑ bot.db.backup""
